<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
		<script src="https://mywebengine.org/myweb/myweb.js?debug=1" type="module" async=""></script>
		<link href="https://mywebengine.org/myweb/myweb.css" type="text/css" rel="stylesheet" />
		<title>Tic-tac-toe - example, myweb</title>
	</head> 
	<body>

<!-- *** имена CSS-классов
	- используются только для применения стилей к элементам *** -->
<h1>Tic-tac-toe - example, myweb</h1>
<div class="x0"
	scope.game=""
	exec="if (!game.score) init(game)"
	attr.class.game_over="game.winner">
	<div class="x0-score">
		<div class="x0-score-i player_x">X = ${game.score.X}</div>
		<div class="x0-score-i player_0">0 = ${game.score["0"]}</div>
	</div>
	<div class="x0-message">${game.message}</div>
	<div if="game.winner">
		<button on.click="newGame(game)">Start new game</button>
	</div>
	<div class="x0-board">
		<div class="x0-board-cell"
			foreach..cell="new Array(9)"
				exec.player="game.log.find(i => i.cell === cell)?.player"
				attr.class.player_x="player === `X`"
				attr.class.player_0="player === `0`"
				on.click="!player && !game.winner && setMove(game, `X`, cell)"></div>
	</div>
	<div class="x0-log">
		<div class="x0-log-title">Game log</div>
		<button class="x0-log-i"
			foreach.move.i="game.log"
				on.click="goToMove(game, i)">Move #${i + 1}: player ${move.player} move to ${move.cell + 1} cell</button>
	</div>
</div>
<script>
	//0 1 2
	//3 4 5
	//6 7 8
	//Все выигрышные комбинации
	const winArr = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
	//Инициализация компонента
	function init(game) {
		game.score = { X: 0, "0": 0 };
		newGame(game);
	}
	//Запускаем новую игру
	function newGame(game) {
		game.currentPlayer = game.currentPlayer !== "X" ? "X" : "0";
		delete game.winner;
		game.log = [];//будет хранить объекты вида: { payer: "X", cell: 1 }
		if (game.currentPlayer === "X") {
			game.message = `The first one walks X is you`;
			return;
		}
                do {//Первый ход 0 случайный (от 0 до 8) и проверяем что бы это был угол
                	const i = Math.floor(9 * Math.random());
			switch (i) {
				case 0:
				case 2:
				case 6:
				case 8:
					setMove(game, "0", i);
					return;
			}
		} while (true);
	}
	//Делаем ход
	function setMove(game, player, cell) {
		if (testWin(game, player, cell)) {
			game.log.push({ player, cell });
			gameOver(game, player, true);
			return;
		}
		game.log.push({ player, cell });
		if (player === "0") {
			game.message = "Your turn";
			return;
		}
		const n0 = getNextMove(game, "0");
		if (n0 === -1) {
			gameOver(game, player, false);
			return;
		}
		if (testWin(game, "0", n0)) {
			setMove(game, "0", n0);
			return;
		}
		const nX = getNextMove(game, "X");
		if (nX !== -1) {
			setMove(game, "0", nX);
		}
		if (getNextMove(game, "X") === -1) {
			gameOver(game, player, false);
			return;
		}
	}
	//Возвращается к предыдущему ходу
	function goToMove(game, i) {
		if (game.winner) {
			if (game.winner !== "DH") {
				game.score[game.winner]--;
			}
			delete game.winner;
		}
		game.log.splice(game.log[i].player === "X" ? i : i - 1);//ход можно отменить, только так что бы X ходил следующим
	}
	//Проверяем ход на победу
	function testWin(game, player, cell) {
		const playerCells = new Set([cell]);
		game.log.forEach(l => l.player === player && playerCells.add(l.cell));
		return winArr.findIndex(line => line.filter(i => playerCells.has(i)).length === 3) !== -1;
	}
	//Вычисляем следующий ход для нашего ИИ
	function getNextMove(game, player) {
		const cells = new Set(),
			playerCells = new Set(),
			rivalCells = new Set();
		game.log.forEach(l => {
			if (l.player === player) {
				playerCells.add(l.cell);
				return;
			}
			rivalCells.add(l.cell);
		});
		const lines = winArr
			.filter(line => line.findIndex(i => rivalCells.has(i)) === -1);
		if (lines.length === 0) {
			return player === "X" ? getNextMove(game, "0") : -1;
		}
		if (player === "0") {
			const line = lines.sort((a, b) => a.filter(i => playerCells.has(i)).length < b.filter(i => playerCells.has(i)).length ? 1 : -1)[0];
			return playerCells.has(line[0]) ? playerCells.has(line[2]) ? line[1] : line[2] : line[0];
		}
		for (let i = lines.length - 1; i > -1; i--) {
			const c = lines[i].filter(i => !playerCells.has(i));
			if (c.length === 1) {
				return c[0];
			}
		}
		return getNextMove(game, "0");
	}
	//Инициализация окончания игры
	function gameOver(game, player, isWin) {
		if (!isWin) {
			game.winner = "DH";
			game.message = "Dead heat";
			return;
		}
		game.winner = player;
		game.message = player + " the winner!";
		game.score[player]++;
	}
</script>
<link href="/doc/examples/x0/ex1/x0.css" type="text/css" rel="stylesheet" />

	</body>
</html>